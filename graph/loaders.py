"""
Graph Loading Utilities - Instructor-provided infrastructure

DO NOT EDIT THIS FILE
Students should use these utilities but not modify them.

This module provides utilities to load graphs from JSON and CSV files.
"""

import json
from typing import Dict, Any
from pathlib import Path
from .graph import Graph


def load_graph(filepath: str) -> Graph:
    """
    Load a graph from a file.
    
    Automatically detects file format (JSON or CSV) and graph properties
    (directed/undirected, weighted/unweighted).
    
    Args:
        filepath: Path to the graph file
        
    Returns:
        A Graph object
        
    Raises:
        ValueError: If file format is not supported
        FileNotFoundError: If file does not exist
    """
    path = Path(filepath)
    
    if not path.exists():
        raise FileNotFoundError(f"Graph file not found: {filepath}")
    
    if path.suffix == '.json':
        return load_json_graph(filepath)
    elif path.suffix == '.csv':
        return load_csv_graph(filepath)
    else:
        raise ValueError(f"Unsupported file format: {path.suffix}")


def load_json_graph(filepath: str) -> Graph:
    """
    Load a graph from a JSON file.
    
    Expected JSON format:
    {
        "directed": true/false,
        "weighted": true/false,
        "edges": [
            {"from": "A", "to": "B", "weight": 1.0},
            ...
        ]
    }
    
    If "weight" is not provided, assumes weight of 1.0.
    If "directed" is not provided, assumes undirected.
    If "weighted" is not provided, detects based on presence of weights.
    
    Args:
        filepath: Path to JSON file
        
    Returns:
        A Graph object
    """
    with open(filepath, 'r') as f:
        data = json.load(f)
    
    # Extract graph properties
    directed = data.get('directed', False)
    weighted = data.get('weighted', False)
    edges = data.get('edges', [])
    blue_vertices = data.get('blue', [])  # Blue vertices for Task 1
    
    # Auto-detect weighted if not specified
    if not weighted and edges:
        weighted = any('weight' in edge for edge in edges)
    
    # Create graph
    graph = Graph(directed=directed, weighted=weighted)
    
    # Add edges
    for edge in edges:
        u = str(edge['from'])
        v = str(edge['to'])
        weight = float(edge.get('weight', 1.0))
        graph.add_edge(u, v, weight)
    
    # Add blue vertices
    if blue_vertices:
        graph.blue = set(str(v) for v in blue_vertices)
    
    return graph


def load_csv_graph(filepath: str) -> Graph:
    """
    Load a graph from a CSV file.
    
    Expected CSV format:
    from,to,weight
    A,B,1.0
    B,C,2.5
    
    If no weight column, assumes unweighted graph with weight 1.0.
    Always assumes undirected unless specified in first line as comment.
    
    Args:
        filepath: Path to CSV file
        
    Returns:
        A Graph object
    """
    import csv
    
    directed = False
    weighted = False
    edges = []
    
    with open(filepath, 'r') as f:
        # Check for directionality comment in first line
        first_line = f.readline().strip()
        if first_line.startswith('#'):
            if 'directed' in first_line.lower():
                directed = True
            # Reset to beginning after comment
            reader = csv.DictReader(f)
        else:
            # First line is header, reset file
            f.seek(0)
            reader = csv.DictReader(f)
        
        for row in reader:
            u = str(row['from'])
            v = str(row['to'])
            
            if 'weight' in row:
                weighted = True
                weight = float(row['weight'])
            else:
                weight = 1.0
            
            edges.append((u, v, weight))
    
    # Create graph
    graph = Graph(directed=directed, weighted=weighted)
    
    # Add edges
    for u, v, weight in edges:
        graph.add_edge(u, v, weight)
    
    return graph
